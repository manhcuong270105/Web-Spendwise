<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spendwise Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-3">
        <div class="container">
            <a class="navbar-brand fw-bold fs-3" href="#">Spendwise</a>

            <div class="collapse navbar-collapse justify-content-end">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item"><a class="nav-link active fw-semibold" href="#">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Budget</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">History</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Category</a></li>
                </ul>
                <div class="d-flex align-items-center ms-4">
                    <i class="fa-solid fa-moon toggle-dark"></i>
                    <div id="user-btn"
                        class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center"
                        style="width: 40px; height: 40px; cursor: pointer;" title="Click để đăng xuất">
                        <i class="fa-solid fa-user"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold">Dashboard</h4>
                <p class="text-muted" id="welcome-message">Welcome Back, ...</p>
            </div>
            <div>
                <button class="btn btn-light border">Income</button>
                <button class="btn btn-secondary">Expense</button>
            </div>
        </div>

        <div class="mb-4">
            <input type="date" class="form-control w-auto" value="2025-11-09">
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card-custom stat-card border-start border-4 border-primary">
                    <h6>Total Income</h6>
                    <h3>$ 3000.00</h3>
                    <span class="small-text">This month</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-custom stat-card border-start border-4 border-danger">
                    <h6>Total Expenses</h6>
                    <h3 id="total-expense-display">$ 0.00</h3> <span class="small-text">This month</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-custom stat-card border-start border-4 border-success">
                    <h6>Balance</h6>
                    <h3>$ 2700.00</h3>
                    <span class="small-text">This month</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card-custom" style="height: 350px;">
                    <h6 class="mb-4">Spending by Category</h6>
                    <div class="d-flex justify-content-center h-100">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card-custom" style="height: 350px;">
                    <h6 class="mb-4">Category Breakdown</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Shopping</span> <span>$180.00</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-secondary" style="width: 60%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Dining</span> <span>$90.00</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-secondary" style="width: 30%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card-custom">
                    <h6 class="mb-3">Recent Transactions</h6>
                    <div id="transaction-list">
                        <p class="text-center text-muted">Đang tải dữ liệu...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const userStr = localStorage.getItem('user');

        if (!userStr) {
            window.location.href = '/login.html';
        } else {
            const user = JSON.parse(userStr);
            const welcomeMsg = document.getElementById('welcome-message');
            const displayName = user.fullName || user.username;
            welcomeMsg.innerText = `Welcome Back, ${displayName}!`;
        }

        document.getElementById('user-btn').addEventListener('click', function () {
            if (confirm("Bạn có muốn đăng xuất?")) {
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            });


        async function fetchExpenses() {
            try {
                const response = await fetch('/api/expenses');
                const expenses = await response.json();
                renderTransactions(expenses);
                updateTotal(expenses);
            } catch (error) {
                console.error("Lỗi:", error);
            }
        }

        function renderTransactions(data) {
            const container = document.getElementById('transaction-list');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<p class="text-center">Chưa có giao dịch nào.</p>';
                return;
            }

            data.forEach(item => {
                const html = `
                <div class="transaction-item">
                    <div class="d-flex align-items-center">
                        <div class="icon-box">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <div>
                            <div class="fw-bold">${item.description}</div>
                            <div class="text-muted small">${item.date}</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="text-danger fw-bold me-4">$${item.amount}</span>
                        <i class="fa-solid fa-pen action-btn"></i>
                        <i class="fa-solid fa-trash action-btn" onclick="deleteExpense(${item.id})"></i>
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });
        }

        function updateTotal(data) {
            const total = data.reduce((sum, item) => sum + item.amount, 0);
            document.getElementById('total-expense-display').innerText = '$ ' + total.toLocaleString();
        }

        const ctx = document.getElementById('pieChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Shopping', 'Dining', 'Pet'],
                datasets: [{
                    data: [60, 30, 10],
                    backgroundColor: ['#5bc0de', '#f0ad4e', '#d9534f'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });

        if (userStr) {
            fetchExpenses();
        }

        async function deleteExpense(id) {
            if (confirm("Xóa giao dịch này?")) {
                await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                fetchExpenses();
            }
        }
    </script>
</body>

</html>